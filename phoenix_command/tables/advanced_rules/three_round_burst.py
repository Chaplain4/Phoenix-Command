import random


class ThreeRoundBurstTable:
    TABLE_9B = {
        -11: {
            28: (99, 97, 89),
            27: (99, 95, 85),
            26: (98, 91, 79),
            25: (96, 87, 73),
            24: (93, 82, 66),
            23: (90, 76, 59),
            22: (86, 69, 52),
            21: (80, 62, 45),
            20: (74, 55, 38),
            19: (68, 48, 32),
            18: (61, 41, 26),
            17: (54, 35, 21),
            16: (47, 29, 17),
            15: (40, 24, 14),
            14: (34, 19, 11),
            13: (29, 16, 8),
            12: (24, 13, 6),
            11: (19, 10, 5),
            10: (16, 8, 4),
            9: (13, 6, 3),
            8: (10, 5, 2),
            7: (8, 4, 1),
            6: (6, 3, 1),
            5: (5, 2, 0),
            4: (4, 2, 0),
            3: (3, 1, 0)
        },
        -6: {
            28: (99, 90, 25),
            27: (99, 86, 20),
            26: (98, 80, 16),
            25: (96, 74, 13),
            24: (94, 67, 10),
            23: (91, 60, 8),
            22: (88, 52, 6),
            21: (83, 45, 4),
            20: (78, 39, 3),
            19: (72, 33, 2),
            18: (66, 27, 2),
            17: (60, 22, 1),
            16: (53, 18, 1),
            15: (46, 15, 0),
            14: (40, 12, 0),
            13: (34, 9, 0),
            12: (29, 7, 0),
            11: (24, 6, 0),
            10: (20, 5),
            9: (16, 4),
            8: (13, 3),
            7: (11, 2),
            6: (8, 2),
            5: (7, 1),
            4: (5, 1),
            3: (4, 1)
        },
        -4: {
            28: (99, 80),
            27: (99, 74),
            26: (98, 67),
            25: (96, 60),
            24: (94, 52),
            23: (91, 45),
            22: (88, 39),
            21: (83, 33),
            20: (78, 27),
            19: (73, 22),
            18: (67, 18),
            17: (61, 15),
            16: (54, 12),
            15: (48, 9),
            14: (42, 7),
            13: (36, 6),
            12: (31, 5),
            11: (26, 4),
            10: (21, 3),
            9: (18, 2),
            8: (14, 2),
            7: (12, 1),
            6: (9, 1),
            5: (7, 1),
            4: (6, 1),
            3: (5, 0)
        },
        -2: {
            28: (99, 52),
            27: (99, 45),
            26: (97, 38),
            25: (96, 32),
            24: (93, 27),
            23: (90, 22),
            22: (86, 18),
            21: (82, 15),
            20: (76, 12),
            19: (71, 9),
            18: (65, 7),
            17: (59, 6),
            16: (53, 5),
            15: (47, 4),
            14: (41, 3),
            13: (35, 2),
            12: (30, 2),
            11: (25, 1),
            10: (21, 1),
            9: (18, 1),
            8: (14, 1),
            7: (12, 0),
            6: (10, 0),
            5: (8, 0),
            4: (6, 0),
            3: (5, 0)
        },
        0: {
            28: (99,),
            27: (98,),
            26: (97,),
            25: (95,),
            24: (93,),
            23: (89,),
            22: (85,),
            21: (80,),
            20: (75,),
            19: (69,),
            18: (63,),
            17: (57,),
            16: (51,),
            15: (45,),
            14: (40,),
            13: (34,),
            12: (30,),
            11: (25,),
            10: (21,),
            9: (18,),
            8: (15,),
            7: (12,),
            6: (10,),
            5: (8,),
            4: (6,),
            3: (5,)
        },
        4: {
            28: (99,),
            27: (98,),
            26: (97,),
            25: (94,),
            24: (91,),
            23: (87,),
            22: (82,),
            21: (76,),
            20: (70,),
            19: (63,),
            18: (57,),
            17: (50,),
            16: (44,),
            15: (38,),
            14: (33,),
            13: (28,),
            12: (24,),
            11: (20,),
            10: (17,),
            9: (14,),
            8: (12,),
            7: (10,),
            6: (8,),
            5: (6,),
            4: (5,),
            3: (4,)
        },
        10: {
            28: (99,),
            27: (98,),
            26: (96,),
            25: (94,),
            24: (90,),
            23: (86,),
            22: (81,),
            21: (75,),
            20: (68,),
            19: (61,),
            18: (54,),
            17: (47,),
            16: (40,),
            15: (34,),
            14: (29,),
            13: (24,),
            12: (20,),
            11: (16,),
            10: (13,),
            9: (11,),
            8: (9,),
            7: (7,),
            6: (6,),
            5: (5,),
            4: (4,),
            3: (3,)
        },
        16: {
            28: (99,),
            27: (98,),
            26: (96,),
            25: (94,),
            24: (90,),
            23: (86,),
            22: (80,),
            21: (74,),
            20: (67,),
            19: (60,),
            18: (53,),
            17: (46,),
            16: (39,),
            15: (33,),
            14: (28,),
            13: (23,),
            12: (19,),
            11: (15,),
            10: (12,),
            9: (10,),
            8: (8,),
            7: (6,),
            6: (5,),
            5: (4,),
            4: (3,),
            3: (2,)
        }
    }

    @classmethod
    def calculate_3rb_hits(cls, eal, rb3_value, log):
        roll = random.randint(0, 99)
        available_3rb = sorted(cls.TABLE_9B.keys())
        target_3rb = min(available_3rb, key=lambda x: abs(x - rb3_value))
        target_eal = max(3, min(28, eal))
        chances = cls.TABLE_9B[target_3rb][target_eal]
        
        log.append(f"[3RB Table 9B] RB3 value: {rb3_value}, Using column: {target_3rb}")
        log.append(f"  EAL: {eal}, Using row: {target_eal}")
        log.append(f"  Hit chances: {chances}")
        log.append(f"  Roll: {roll}")
        
        hits = 0
        for i, chance in enumerate(chances):
            if roll <= chance:
                hits += 1
                log.append(f"  Round {i+1}: {roll} <= {chance}, HIT")
            else:
                log.append(f"  Round {i+1}: {roll} > {chance}, MISS")
                break
        
        log.append(f"  Total hits: {hits}")
        return hits
