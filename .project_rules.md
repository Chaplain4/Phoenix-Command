# Phoenix Command Project Structure

## Модели (phoenix_command/models/)

### enums.py - Перечисления
- **TargetOrientation** (строка 5) - Ориентация цели относительно стрелка
- **IncapacitationEffect** (строка 12) - Эффекты недееспособности от ранений
- **ShooterStance** (строка 20) - Стойка стрелка
- **TargetExposure** (строка 26) - Экспозиция цели (Table 4E)
- **ExplosiveTarget** (строка 43) - Цели для взрывчатки
- **DamageType** (строка 48) - Типы урона
- **WoundType** (строка 52) - Типы ранений
- **HitLocation** (строка 62) - Базовые локации попаданий
- **AdvancedHitLocation** (строка 88) - Расширенные локации попаданий с таблицами урона
- **MedicalAid** (строка 258) - Уровни медицинской помощи
- **ShotType** (строка 265) - Типы выстрелов (одиночный/очередь)
- **SituationStanceModifier4B** (строка 269) - Модификаторы стойки (Table 4B)
- **VisibilityModifier4C** (строка 288) - Модификаторы видимости (Table 4C)
- **AccuracyModifiers** (строка 305) - Типы модификаторов точности
- **AmmoFeedDevice** (строка 312) - Тип подачи боеприпасов
- **ArmorMaterial** (строка 319) - Материалы брони с деградацией
- **Caliber** (строка 369) - Калибры оружия
- **WeaponType** (строка 403) - Типы оружия
- **GrenadeType** (строка 419) - Типы гранат
- **BlastModifier** (строка 426) - Модификаторы взрыва
- **Country** (строка 436) - Страны производители

### gear.py - Снаряжение
- **BallisticData** - Баллистические характеристики на дистанции
- **ExplosiveData** - Характеристики взрывчатки
- **RangeData** - Данные для конкретной дистанции
- **WeaponBallisticData** - Полные баллистические данные оружия
  - `get_three_round_burst(range_hexes)` - получить 3RB
  - `get_minimum_arc(range_hexes)` - получить MA
  - `get_ballistic_accuracy(range_hexes)` - получить BA
  - `get_time_of_flight(range_hexes)` - получить TOF
- **Gear** - Базовый класс снаряжения
- **AmmoType** - Тип боеприпасов
  - `get_pen(range_hexes)` - пробитие
  - `get_dc(range_hexes)` - класс урона
  - `get_base_shrapnel_hit_chance(range_hexes)` - шанс попадания осколков
  - `get_explosion_pen(range_hexes)` - пробитие осколков
  - `get_explosion_dc(range_hexes)` - DC осколков
  - `get_base_concussion(range_hexes)` - контузия
- **ArmorLayer** - Слой брони
- **ArmorProtectionData** - Данные защиты брони для локации
- **Armor** - Броня
  - `gost_class` - класс ГОСТ
  - `nij_class` - класс NIJ
  - `add_protection()` - добавить защиту
  - `get_protection()` - получить защиту
  - `process_hit()` - обработать попадание
- **Weapon** - Оружие
  - Поля: caliber, weapon_type, country, length_deployed, length_folded, reload_time и т.д.
- **Grenade** - Граната

### character.py - Персонаж
- Модель персонажа с характеристиками, здоровьем и снаряжением

### hit_result_advanced.py - Результаты попадания (расширенные)
- **ShotParameters** - Параметры выстрела (aim_time, модификаторы, скорости)
- **ShotResult** - Результат выстрела (hit, eal, odds, roll, damage_result)
- **TargetGroup** - Группа целей для автоматического огня
- **BurstElevationResult** - Результат проверки возвышения очереди
- **DamageResult** - Результат урона (location, damage, shock, pierced_organs, is_disabled)
- **ExplosiveShotResult** - Результат взрывного выстрела

### hit_result_simple.py - Результаты попадания (простые)
- **HitResult** - Упрощённый результат попадания

### recovery.py - Восстановление
- **Recovery** - Данные восстановления (healing_days, aid_map)

---

## Симуляции (phoenix_command/simulations/)

### character_generator.py - Генератор персонажей (строки 1-35)

**CharacterGenerator** - Класс генерации персонажей

| Метод | Строка | Описание |
|-------|--------|----------|
| `roll_characteristic()` | 12 | Бросок 3d6 для характеристики |
| `generate_character(gun_combat_skill_level, strength?, intelligence?, will?, health?, agility?)` | 17 | Создание персонажа с указанным уровнем навыка стрельбы. Опциональные характеристики генерируются броском 3d6 |

### combat_simulator.py - Симулятор боя (строки 1-450+)

**CombatSimulator** - Основной класс симуляции боя (все методы)

| Метод | Строка | Описание |
|-------|--------|----------|
| `get_shotgun_pattern_radius(ammo, range_hexes)` | 22 | Получить радиус разлёта дроби на дистанции |
| `single_shot(shooter, target, weapon, ammo, range_hexes, target_exposure, shot_params, is_front_shot)` | 27 | **Одиночный выстрел.** Рассчитывает EAL, шансы попадания (SINGLE), бросает d100, обрабатывает урон и недееспособность |
| `shotgun_shot(shooter, targets, weapon, ammo, ranges, exposures, shot_params_list, is_front_shots, primary_target_idx?)` | 57 | **Выстрел дробовика.** Поддерживает множественные цели в паттерне разлёта дроби. Проверяет SALM на первичную цель |
| `burst_fire(shooter, weapon, ammo, target_group, arc_of_fire?, continuous_burst_impulses?)` | 96 | **Автоматический огонь (очередь).** Обрабатывает дугу огня, SAB штраф, проверку возвышения, распределение попаданий по целям согласно EAL |
| `three_round_burst(shooter, target, weapon, ammo, range_hexes, target_exposure, shot_params, is_front_shot)` | 166 | **Очередь в три патрона (3RB).** Получает 3RB modifier из ballistic_data, рассчитывает количество попаданий через ThreeRoundBurstTable |
| `shotgun_burst_fire(shooter, weapon, ammo, primary_target_group, pattern_target_groups, arc_of_fire?, continuous_burst_impulses?)` | 195 | **Автоматический огонь дробовиком.** Комбинирует burst_fire + shotgun_shot, обрабатывает паттерны для нескольких целей |
| `explosive_weapon_shot(shooter, weapon, ammo, range_hexes, target, shot_params)` | 268 | **Выстрел взрывчатой гранаты.** Рассчитывает EAL для взрывчатки, определяет попадание/разброс. При промахе рассчитывает scatter_hexes и is_long |
| `thrown_grenade(shooter, range_hexes, target, aim_time_ac, situation_stance_modifiers, visibility_modifiers)` | 296 | **Брошенная граната.** Расчёт EAL для гранаты (без движения стрелка), определение попадания/разброса |
| `automatic_grenade_launcher_burst(shooter, weapon, range_hexes, target, shot_params, arc_of_fire?, continuous_burst_impulses?)` | 328 | **Автоматический гранатомёт.** Комбинирует burst_fire логику для гранат, рассчитывает разброс для каждой гранаты в очереди |

### combat_simulator_utils.py - Утилиты симулятора (строки 1-600+)

**CombatSimulatorUtils** - Вспомогательные методы

| Метод | Строка | Описание |
|-------|--------|----------|
| `redistribute_hits_by_eal(shooter, weapon, target_hits, sab_penalty)` | 20 | Перераспределение попаданий пропорционально EAL если превышен ROF |
| `check_shotgun_burst_elevation_and_get_hits(shooter, target, weapon, range_hexes, exposure, shot_params, arc_of_fire, sab_penalty, salm)` | 59 | Проверка возвышения для дробовика в режиме очереди |
| `get_shotgun_data_at_range(ammo, range_hexes)` | 77 | Получить SALM, BPHC, PR дробовика на дистанции |
| `validate_shotgun_inputs(targets, ranges, exposures, shot_params_list, is_front_shots)` | 85 | Валидация входных данных дробовика |
| `calculate_shotgun_eal(shooter, target, weapon, range_hexes, exposure, shot_params, salm, sab_penalty?)` | 93 | Расчёт EAL для дробовика (использует max(Target Size ALM, SALM)) |
| `check_burst_elevation_and_get_hits(shooter, target, weapon, range_hexes, exposure, shot_params, arc_of_fire, sab_penalty)` | 107 | Проверка возвышения и расчёт попаданий для очереди |
| `setup_burst_fire(weapon, target_group, continuous_burst_impulses, arc_of_fire, shooter)` | 120 | Настройка параметров автоматического огня (SAB штраф, дуга огня) |
| `calculate_eal(shooter, target, weapon, range_hexes, target_exposure, shot_params, target_size_modifier_type?)` | 155 | **Расчёт Effective Accuracy Level (EAL).** Суммирует все ALM: aim time, range, stance, visibility, movement, duck, defensive. Ограничивает BA |
| `determine_incapacitation(target, pd_total, shock)` | 220 | Определение эффекта недееспособности (шанс и тип) |
| `process_hit(target, ammo, range_hexes, target_exposure, shot_params, is_front_shot)` | 235 | **Обработка попадания.** Определяет локацию, проверяет броню, рассчитывает урон/тупой урон, недееспособность |
| `process_target_hits(target, ammo, range_hexes, exposure, shot_params, is_front_shot, hits)` | 280 | **Обработка множественных попаданий** на одну цель. Повторяет `process_hit()` N раз |
| `validate_burst_fire_inputs(weapon, targets, ranges, exposures, shot_params_list, is_front_shots, continuous_burst_impulses)` | 305 | **Валидация автоматического огня.** Проверяет full_auto, ballistic_data, lengths, SAB penalty |
| `check_elevation_and_calculate_hits(eal, exposure, weapon, arc_of_fire)` | 344 | **Проверка возвышения и расчёт попаданий.** Бросает на EAL (BURST), использует Table5 для дуги и ROF |
| `process_shotgun_pattern(ammo, targets, ranges, exposures, shot_params_list, is_front_shots, bphc)` | 360 | **Обработка паттерна дробовика.** Рассчитывает попадания дроби для всех целей в паттерне |
| `calculate_pellet_hits_per_target(targets, ranges, exposures, shot_params_list, is_front_shots, bphc)` | 381 | **Расчёт попаданий дроби для каждой цели.** BPHC (Base Pellet Hit Chance) - гарантированная или вероятностная |
| `redistribute_pellets(pellet_hits_data, pellet_count)` | 415 | **Перераспределение дроби** если общее количество превышает pellet_count оружия |
| `calculate_explosive_eal(shooter, weapon, range_hexes, target_size_alm, shot_params)` | 441 | **Расчёт EAL для взрывчатки.** Учитывает движение стрелка, время прицеливания, дальность |
| `calculate_grenade_eal(shooter, range_hexes, target_size_alm, aim_alm, situation_stance_modifiers, visibility_modifiers)` | 480 | **Расчёт EAL для брошенной гранаты.** ALM от дальности, стойки, видимости, уровня умения |

---

## Таблицы (phoenix_command/tables/)

### core/ - Основные таблицы

#### table1_character_generation.py - Генерация персонажа
- Таблицы для создания персонажей

#### table2_odds_of_hitting.py - Шансы попадания (базовые)

**Table2OddsOfHitting** - Базовые таблицы попадания

| Метод | Строка | Описание |
|-------|--------|----------|
| `get_odds_of_hitting_2a(shot_accuracy, range_in_hexes)` | 7 | **Шанс попадания (%)** по точности выстрела и дистанции. SA от -30 до +34, дистанция до 300 гексов |
| `get_multiple_hits_2b(target_range, rate_of_fire)` | 80 | **Количество попаданий** при автоматическом огне. ROF: 4-8, 9-15, 16+ |

#### table3_hit_location_and_damage.py - Локация попадания и урон

**Table3HitLocationAndDamage** - Таблицы урона по локациям

| Данные | Строка | Описание |
|--------|--------|----------|
| `LOW_DAMAGE` | 10 | Словарь: локация → (урон, тип ранения) для низкоскоростного урона |
| `OPPD_DAMAGE` | 35 | Словарь: локация → список [(урон, тип ранения)] для сквозного урона по 4 столбцам |

#### table4_advanced_odds_of_hitting.py - Расширенные шансы попадания

**Table4AdvancedOddsOfHitting** - Расширенные таблицы 4A-4G

| Метод | Строка | Описание |
|-------|--------|----------|
| `get_accuracy_level_modifier_by_range_4a(distance)` | 9 | **ALM по дистанции (Table 4A).** От +33 (1 hex) до -27 (4350 hexes) |
| `get_odds_of_hitting_4g(effective_accuracy_level, shot_type)` | 65 | **Шанс попадания по EAL (Table 4G).** EAL от -22 до +28, Single/Burst |
| `get_standard_target_size_modifier_4e(target_exposure, modifier_type)` | 130 | **Модификатор размера цели (Table 4E).** TARGET_SIZE, AUTO_ELEV, AUTO_WIDTH |
| `get_movement_alm_and_max_aim_time_4d(speed_hex_per_impulse, range_hexes)` | ~180 | **ALM движения и макс. время прицеливания (Table 4D)** |

#### table5_auto_pellet_shrapnel.py - Автоматика/дробь/осколки

**Table5AutoPelletShrapnel** - Таблицы 5A-5C

| Метод | Строка | Описание |
|-------|--------|----------|
| `get_fire_table_value5a(arc_of_fire, rate_of_fire, size_modifier)` | 15 | **Попадания при автоматическом огне (Table 5A).** Дуга 0.2-188°, ROF 3-144. Возвращает гарантированные (*N) или вероятностные попадания |
| `get_shrapnel_pellet_hits_5a(base_shrapnel_pellet_hit_chance, is_guaranteed, size_modifier)` | 95 | **Попадания дроби/осколков.** Базовый шанс 0-100, модификатор размера |
| `get_scatter_distance_5c(sa_difference)` | 140 | **Дистанция разлёта (Table 5C)** |

#### table8_healing_and_recovery.py - Лечение и восстановление

**Table8HealingAndRecovery** - Таблицы 8A-8B

| Метод | Строка | Описание |
|-------|--------|----------|
| `get_incapacitation_time_8b(physical_damage_total, modifier?)` | 13 | **Время недееспособности в фазах (Table 8B).** PD 50-1000+, бросок d10 с модификатором |
| `get_critical_time_period_and_recovery_chance_8a(physical_damage, target_health)` | 40 | **Критический период и шанс выживания (Table 8A).** Возвращает Recovery с данными для каждого уровня мед. помощи |
| `get_incapacitation_chance(pd_with_shock, knockout_value)` | 115 | **Шанс недееспособности (%).** 0/10/25/75/98% в зависимости от PD/KO ratio |
| `get_incapacitation_effect(pd_with_shock, knockout_value, effect_roll)` | 125 | **Тип недееспособности.** DISORIENTED/DAZED/STUNNED/KNOCKED_OUT по d100 |

---

### advanced_damage_tables/ - Таблицы расширенного урона

#### advanced_damage_calculator.py - Калькулятор урона

**AdvancedDamageCalculator** - Расчёт урона по расширенным таблицам

| Метод | Строка | Описание |
|-------|--------|----------|
| `calculate_damage(location, dc, epen, is_front)` | 11 | **Основной метод расчёта урона.** Парсит таблицы из локации, обрабатывает FRONT/REAR, возвращает DamageResult |
| `_process_front_table(data, thresholds, dc_values, epen, final_res)` | 50 | Обработка фронтального попадания (penetration_idx, organs, shock) |
| `_process_rear_table(data, thresholds, dc_values, epen, final_res)` | 65 | Обработка тылового попадания (stop_threshold, excess_epen) |
| `_collect_organs_along_path(data, thresholds, path, final_res, is_front)` | 85 | Сбор поражённых органов вдоль траектории |
| `_calculate_front_shock(data, thresholds, path)` | 100 | Расчёт шока для фронтального попадания |
| `_calculate_rear_shock(data, thresholds, stop_idx)` | 110 | Расчёт шока для тылового попадания |

#### table_1_get_hit_location.py - Определение локации попадания

**Table1AdvancedDamageHitLocation** - Расширенные локации

| Метод | Строка | Описание |
|-------|--------|----------|
| `get_hit_location(exposure, orientation)` | 10 | **Основной метод.** Выбирает таблицу по ориентации |
| `get_hit_location_front_rear(exposure)` | 22 | **Локация FRONT/REAR.** d100 для укрытия, d1000 для открытого пространства |
| `get_hit_location_oblique(exposure)` | ~150 | Локация OBLIQUE (косое) |
| `get_hit_location_right_side(exposure)` | ~250 | Локация RIGHT_SIDE |
| `get_hit_location_left_side(exposure)` | ~350 | Локация LEFT_SIDE |

#### tables_data.py - Данные таблиц урона
- **TablesData.TABLES_DATA** - Словарь таблиц 1-64 с данными:
  - `epen` - пороги проникновения
  - `dc` - значения урона по DC
  - `organs` - органы (start, end, name, is_gray)
  - `shock` - значения шока

---

### advanced_rules/ - Расширенные правила

#### blunt_damage.py - Тупой урон

**Table9ABluntDamage** - Тупой урон от брони

| Метод | Описание |
|-------|----------|
| `get_blunt_damage(location, blunt_pf, penetration)` | Расчёт тупого урона при непробитии брони |

#### effective_min_arc.py - Эффективная минимальная дуга

**EffectiveMinimumArc** - Расчёт эффективной MA

| Метод | Строка | Описание |
|-------|--------|----------|
| `get_effective_ma(base_ma, weapon_type, stance, strength, is_one_handed?, is_moving?)` | 25 | **Эффективная MA с модификаторами.** Учитывает: тип оружия (rifle/MG), стойку, силу (3-8/12-15/16-18), одну руку, движение |

Данные таблицы (строки 3-15):
- `rifle_standing/kneeling/prone` - MA для винтовок по стойкам
- `mg_standing/kneeling/hip` - MA для пулемётов по стойкам
- `str_3_8/12_15/16_18` - модификаторы силы
- `one_hand` - стрельба одной рукой
- `moving` - стрельба в движении

#### three_round_burst.py - Очередь в три патрона

**ThreeRoundBurstTable** - Таблица 9B

| Данные | Строка | Описание |
|--------|--------|----------|
| `TABLE_9B` | 6 | Словарь: 3RB modifier → {EAL → (1st, 2nd, 3rd shot odds)} |

3RB модификаторы: -11, -6, -4, -2, 0, +2, +4, +6
EAL: от 3 до 28

---

## База данных предметов (phoenix_command/item_database/)

### weapons.py - Оружие
- **Боеприпасы** (строки 10-2500) - AmmoType объекты
- **Баллистические данные** (строки 580-650) - WeaponBallisticData объекты
- **Оружие** (строки 6509+) - Weapon объекты с enum Caliber, WeaponType, Country

### armor.py - Броня
- Определения бронежилетов и защитного снаряжения

### grenades.py - Гранаты
- Определения гранат

### equipment.py - Снаряжение
- Прочее снаряжение

---

## Тесты (tests/)

### simulations/
- test_character_armor.py
- test_character_generator.py
- test_combat_simulator.py

### tables/
- advanced_damage_tables/
  - test_advanced_damage_calculator.py

---

## Ключевые Enum для оружия

```python
from phoenix_command.models.enums import Caliber, WeaponType, Country, AmmoFeedDevice

# Caliber - калибры
Caliber.CAL_556_NATO       # 5.56mm NATO
Caliber.CAL_9MM_PARABELLUM # 9mm Parabellum
Caliber.CAL_762_NATO       # 7.62mm NATO
Caliber.CAL_545X39         # 5.45 x 39.5mm
Caliber.CAL_762X39         # 7.62 x 39mm
# ... и другие

# WeaponType - типы оружия
WeaponType.AUTOMATIC_PISTOL
WeaponType.SUB_MACHINEGUN
WeaponType.ASSAULT_RIFLE
WeaponType.BATTLE_RIFLE
WeaponType.CARBINE
WeaponType.SNIPER_RIFLE
WeaponType.MACHINE_GUN
# ... и другие

# Country - страны
Country.USA
Country.USSR
Country.WEST_GERMANY
Country.SWITZERLAND
# ... и другие
```

---

## Поток расчёта выстрела

```
1. CombatSimulator.single_shot()
   ↓
2. CombatSimulatorUtils.calculate_eal() → EAL
   - aim_time_alm (из weapon.aim_time_modifiers)
   - range_alm (Table4A)
   - stance_alm, visibility_alm, movement_alm, duck_alm
   - min(BA, sum_alm) + target_size_alm
   ↓
3. Table4AdvancedOddsOfHitting.get_odds_of_hitting_4g(eal, shot_type) → odds%
   ↓
4. random.randint(0,99) ≤ odds → HIT/MISS
   ↓
5. CombatSimulatorUtils.process_hit()
   - Table1AdvancedDamageHitLocation.get_hit_location() → location
   - ammo.get_pen/get_dc() → pen, dc
   - armor.process_hit() → penetrated, epen, blunt_pf
   - AdvancedDamageCalculator.calculate_damage() → DamageResult
   ↓
6. Table8HealingAndRecovery.get_incapacitation_*() → effect, time
```
